<!DOCTYPE html>
<html lang="en">
  <head>
    <title>BITC</title>
    
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="GOLING (Go Healing)" />
    <meta name="keywords" content="goling team" />
    
    <!-- Icon -->
    <link rel="icon" href="../images/logo1.png" />

    <!--boostrap-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker3.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">

    <!-- Symbols -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <script type="text/javascript"
            src="https://app.sandbox.midtrans.com/snap/snap.js"
            data-client-key="SB-Mid-client-WRrnBAPxArMioHRQ">
    </script>
</head>

  <body>
    <header>
      <div id="navbarId" class="navbar">
        <div class="headerInner">
          <h1 class="headerTitle">
            BITC
          </h1>
          <ul class="navigationResponsive">
            <li>
                <button id="navigationDrawerId" class="navigationDrawer" aria-label="Open navigation drawer">☰</button>
            </li>
          </ul>
        </div>
        <nav id="navbarContainerId" class="navbarContainer">
          <ul class="navbarList">
            <li class="navbarItem"><a href="./index.html">Home</a></li>
            <li class="navbarItem"><a href="./index.html#destinations">Tentang Kami</a></li>
            <li class="navbarItem dropdown">
              <a href="./complaints.html" class="dropdown-toggle">Complaints</a>
              <ul class="dropdown-menu">
                <li><a href="./callcenter.html">Call Center</a></li>
                <li><a href="./contact-section.html">Contact</a></li>
              </ul>
            </li>
            <li class="navbarItem dropdown"> <a href="#" class="dropdown-toggle">Sewa</a> 
              <ul class="dropdown-menu"> 
                <li><a href="./bookingVoffice.html">Sewa Virtual Office</a></li> 
                <li><a href="./ruangrapat.html">Sewa Ruang Rapat</a></li> 
              </ul> 
            </li>
          </ul>
        </nav>
      </div>
      <div class="hero">
        <div class="heroContainer">
          <h1 class="heroTitle">Baros Information Technology</h1>
          <h2 class="heroTitle">Creative</h2>
        </div>
      </div>
    </header>

    <section id="sewa-ruangan" class="container mt-5">
      <div class="row">
        <h2>Sewa Ruangan</h2>
        <form id="bookingForm" method="POST">
          <div class="personal-information">
            <h5>Personal Information</h5>
            <div class="form-name">
              <input type="text" id="fullname" name="fullname" required>
              <label for="fullname">Full Name</label>
            </div>
            <div class="form-checkbox" required>
              <h5>Pilih Gender:</h5>
              <div class="form-check mt-2">
                <input class="form-check-input radio-gender" type="radio" name="gender" id="Laki-Laki" value="Laki-Laki" required>
                <label for="Laki-Laki">Laki-Laki</label>
              </div>
              <div class="form-check mt-2">
                <input class="form-check-input radio-gender" type="radio" name="gender" id="Perempuan" value="Perempuan" required>
                <label for="Perempuan">Perempuan</label>
              </div>
            </div>
            <div class="form-email">
              <input type="email" id="email" name="email" required>
              <label for="email">Email Address</label>
            </div>
            <div class="form-phonenumber">
              <input type="tel" id="phonenumber" name="phonenumber" pattern="\+62-[0-9]{4}-[0-9]{3}-[0-9]{4}" required>
              <label for="phonenumber">Phone Number</label>
            </div>
          </div>
          <div class="product-information">
            <h5>Product Information</h5>
            <div class="form-typeruangan">
              <select class="form-select" name="typeruangan" id="floatingroom" required>
                <option value = "" selected>Loading....</option>
              </select>
              <label for="floatingselect">Pilih Type Virtual Office</label>
            </div>
            <div class="form-duration mb-3">
              <select class="form-select" name="duration" id="floatingduration" required>
                <option value="" selected>Select Duration</option>
              </select>
              <label for="floatingduration">Pilih Durasi Penyewaan</label>
            </div>
            <div class="form-start-date">
              <label for="startDate">Tanggal Mulai</label>
              <input type="date" id="startDate" name="startDate" required>
            </div>
            
            <div class="form-end-date">
              <label for="endDate">Tanggal Berakhir</label>
              <input type="date" id="endDate" name="endDate" readonly>
            </div>

          </div>
          <div class="form-total-price">
            <input type="hidden" id="initialRoomPrice" name="initialRoomPrice" value="0">
            <h5>Total Price:</h5>
            <p id="totalPrice">Rp 0</p>
          </div>

           <div id="errorMessage" style="color: red; display: none;"></div>

          <button id='pay-button' type="submit" class="btn btn-primary" value="booking">PESAN</button>

        </form>
      </div>
    </section>    

    <!-- Footer Section -->
    <footer id="contact">
      <div class="foot">
        <div class="footer-content">
          <div class="footlinks">
            <h4>Quick Links</h4>
            <ul>
              <li><a href="./index.html">Home</a></li>
              <li><a href="./index.html#destinations">Tentang Kami</a></li>
              <li><a href="./index.html#contact">Informasi</a></li>
              <li><a href="./about.html">Contact</a></li>
            </ul>
          </div>

          <div class="footlinks">
            <h4>Contact</h4>
            <ul>
              <li class="contact-item">
                <a href="#" class="contact-link">Admin : (022) 86121025</a>
              </li>
              <li class="contact-item">
                <a href="#" class="contact-link">Email : technopark@cimahikota.go.id</a>
              </li>
              <li class="contact-item">
                <address>Jl. HMS Mintareja Sarjana Hukum, Baros, Kec. Cimahi Tengah, Kota Cimahi, Jawa Barat 40521</address>
              </li>
            </ul>
          </div>

          <div class="footlinks">
            <h4>Social Media</h4>
            <div class="social">
              <a href="https://web.whatsapp.com/send?phone=6281223020029" target="https://web.whatsapp.com/send?phone=6281223020029"><i class="bx bxl-whatsapp"></i></a>
              <a href="https://www.facebook.com/technopark.cimahi/" target="https://www.facebook.com/technopark.cimahi/"><i class="bx bxl-facebook"></i></a>
              <a href="https://www.instagram.com/technopark.cimahi/" target="https://www.instagram.com/technopark.cimahi/"><i class="bx bxl-instagram"></i></a>
              <a href="https://x.com/i/flow/login?redirect_after_login=%2Fcimahitpark" target="https://x.com/i/flow/login?redirect_after_login=%2Fcimahitpark"><i class="bx bxl-twitter"></i></a>
              <a href="https://www.youtube.com/@cimahitechnopark4127" target="https://www.youtube.com/@cimahitechnopark4127"><i class="bx bxl-youtube"></i></a>
            </div>
          </div>
        </div>
      </div>

      <div class="end">
        <p>BITC © 2024 All Rights Reserved</p>
      </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
        const roomSelect = document.getElementById('floatingroom');
        const durationSelect = document.getElementById('floatingduration');
        const totalPriceElement = document.getElementById('totalPrice');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const errorMessageElement = document.getElementById('errorMessage');
        const initialRoomPriceInput = document.getElementById('initialRoomPrice');

        const today = new Date();
        const formattedToday = today.toISOString().split('T')[0];
        startDateInput.setAttribute('min', formattedToday);

        async function fetchBookedDates() {
            try {
                const response = await fetch('/bookedTanggal');
                if (!response.ok) {
                    throw new Error('Network response not ok');
                }
                const data = await response.json();
                return data.bookedDates;
            } catch (error) {
                console.log('Error fetching booked dates: ', error);
                return [];
            }
        }

        const bookedDates = await fetchBookedDates();

        function unavailableDate(date) {
            const formattedDate = date.toISOString().split('T')[0]; 
            return [bookedDates.indexOf(formattedDate) === -1];
        }

        $('#startDate').datepicker({
            format: 'yyyy-mm-dd',
            startDate: new Date(),
            beforeShowDay: unavailableDate,
            autoclose: true,
            todayHighlight: true
        }).on('changeDate', function(e) {
            const selectedDate = e.date;
            const formattedSelectedDate = selectedDate.toISOString().split('T')[0];
            
            if (bookedDates.includes(formattedSelectedDate)) {
                errorMessageElement.textContent = 'Tanggal sudah dipesan, silahkan pilih tanggal lain';
                errorMessageElement.style.display = 'block';
                startDateInput.value = '';
                endDateInput.value = '';
            } else {
                errorMessageElement.style.display = 'none';
                updateEndDate();
            }
        });

        $('#endDate').datepicker({
            format: 'yyyy-mm-dd',
            startDate: new Date(),
            autoclose: true,
            todayHighlight: true
        });

        async function fetchroom() {
            try {
                const response = await fetch('http://localhost:5000/room');
                if (!response.ok) {
                    throw new Error('Gagal Mengambil Data Ruangan');
                }
                const data = await response.json();
                console.log("Data Ruangan: ", data);
                populateRoomDropdown(data.rooms);
            } catch (error) {
                console.log('Error fetching room: ', error);
            }
        }

        function populateRoomDropdown(rooms) {
            roomSelect.innerHTML = '<option value = "" selected>Pilih Type Ruangan</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.ID_Ruangan;
                option.textContent = `${room.Type_Ruangan} - Rp ${room.Harga}`;
                roomSelect.appendChild(option);
            });
        }

        roomSelect.addEventListener('change', function(){
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];

            if (selectedOption && selectedOption.textContent) {
                const priceText = selectedOption.textContent.split('- Rp ')[1];
                if (priceText) {
                    roomPrice = parseFloat(priceText.replace(/\./g, '').replace(',','.'));
                    initialRoomPriceInput.value = roomPrice;
                    updatePrice();
                    updateDurationOptions(roomSelect.value);
                } else {
                    console.error('Price text is undefined or not in expected format.');
                }
            } else {
                console.error('No option selected or selected option is undefined.');
            }
        });

        function updateEndDate() {
            const selectedDuration = durationSelect.value;
            const startDate = new Date(startDateInput.value);

            if (!isNaN(startDate.getTime())) {
                let endDate = new Date(startDate);
                if (selectedDuration === '6 bulan') {
                    endDate.setMonth(endDate.getMonth() + 6);
                } else if (selectedDuration === '12 bulan') {
                    endDate.setFullYear(endDate.getFullYear() + 1);
                } else if (selectedDuration === '24 bulan') {
                    endDate.setFullYear(endDate.getFullYear() + 2);
                } else {
                    endDateInput.value = '';
                }

                const formattedEndDate = endDate.toISOString().split('T')[0];
                endDateInput.value = formattedEndDate;
            } else {
                endDateInput.value = '';
            }
        }

        async function updatePrice() {
          const selectedDuration = durationSelect.value;
          let totalPrice = 0;

          if (roomPrice) {
              if (selectedDuration === '6 bulan') {
                totalPrice = roomPrice * 6;
              } else if (selectedDuration === '12 bulan') {
                totalPrice = roomPrice * 12;
              } else if (selectedDuration === '24 bulan') {
                totalPrice = roomPrice * 24;
              }
              totalPriceElement.textContent = `Rp ${totalPrice.toLocaleString()}`;
            } else {
              totalPriceElement.textContent = `Rp 0`;
            }
        }

        function updateDurationOptions(selectedRoom) {
            durationSelect.innerHTML = `<option value="" selected>Select Duration</option>`; // Reset options

            if (selectedRoom === '1') {
                durationSelect.innerHTML += `
                    <option value="6 bulan">6 Bulan</option>
                    <option value="12 bulan">12 Bulan</option>
                    <option value="24 bulan">24 Bulan</option>
                `;
            } else if (selectedRoom === '2') {
                durationSelect.innerHTML += `
                    <option value="6 bulan">6 Bulan</option>
                    <option value="12 bulan">12 Bulan</option>
                    <option value="24 bulan">24 Bulan</option>
                `;
            } else if (selectedRoom === '3') {
                durationSelect.innerHTML += `
                    <option value="6 bulan">6 Bulan</option>
                    <option value="12 bulan">12 Bulan</option>
                    <option value="24 bulan">24 Bulan</option>
                `;
            } else if (selectedRoom === '4') {
                durationSelect.innerHTML += `
                    <option value="6 bulan">6 Bulan</option>
                    <option value="12 bulan">12 Bulan</option>
                    <option value="24 bulan">24 Bulan</option>
                `;
            }
        }

        startDateInput.addEventListener('change', updateEndDate);
        durationSelect.addEventListener('change', function() {
            updateEndDate();
            updatePrice();
        });
        roomSelect.addEventListener('change', function() {
            updateDurationOptions(roomSelect.value);
            updatePrice();
        });
        fetchroom();
    });
    </script>

    <script type="text/javascript">
      const initialRoomPriceInput = document.getElementById('initialRoomPrice');
      document.getElementById('pay-button').onclick = async function (event) {
          event.preventDefault(); 

          const formData = new FormData(document.getElementById('bookingForm'));
          const data = Object.fromEntries(formData.entries());

          data.Email = document.getElementById('email').value;
          data.typeruangan = document.getElementById('floatingroom').value;
          data.initialRoomPrice = initialRoomPriceInput.value;

          try {
              const paymentResponse = await fetch('http://localhost:5000/payment', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data),
              });

              if(!paymentResponse.ok){
                  throw new Error("Gagal melakukan pembayaran, coba lagi");
              }

              const paymentResult = await paymentResponse.json();
              const transactionToken = paymentResult.transactionToken;
              const paymentSuccess = false;

              snap.pay(transactionToken, {
                  onSuccess: function(result) {
                      console.log('Payment success!', result);
                      alert("Pembayaran Berhasil, Tunggu 1-2 Menit untuk mendapatkan bukti pembayaran melalui email");
                      paymentSuccess = true;
                  },
                  onError: function(result) {
                      console.log('Payment error!', result);
                      alert('Pembayaran Mengalami Error')
                  },
                  onClose: function() {
                      console.log('Payment popup closed');
                      alert("Pembayaran ditutup, otomatis dibatalkan")
                  }
              });
          } catch (error) {
              console.error('Error:', error);
              alert('Check Form / Kendala dalam pembayaran');
          }
      };
    </script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  </body>
</html>