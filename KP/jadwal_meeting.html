<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Ruangan</title>
    <link rel="stylesheet" href="kelola_jadwal.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
</head>
<body>
    <div class="sidebar">
        <div class="logo"></div>
        <ul class="menu">
            <li>
                <a href="complaint.html">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Complaint</span>
                </a>
            </li>
            <li>
                <a href="keperluan.html">
                    <i class="fas fa-briefcase"></i>
                    <span>Keperluan</span>
                </a>
            </li>
            <li>
                <a href="statik.html">
                    <i class="fas fa-chart-line"></i>
                    <span>Grafik</span>
                </a>
            </li>
            <li>
                <a href="kelola_paket.html">
                  <i class="fas fa-box"></i>
                  <span>Pesanan Virtual Office</span>
                </a>
              </li>
              <li>
                <a href="PesananRuangMeeting.html">
                  <i class="fas fa-box"></i>
                  <span>Pesanan Ruang Meeting</span>
                </a>
              </li>
            <li>
                <a href="kelola_ruangan.html">
                    <i class="fas fa-building"></i>
                    <span>Kelola Virtual Office</span>
                </a>
            </li>
            <li>
                <a href="kelola_RMeeting.html">
                    <i class="fas fa-user"></i>
                    <span>Kelola Ruang<br>Meeting</span>
                </a>
            </li>
            <li>
                <a href="jadwal_meeting.html">
                    <i class="fa fa-clock"></i>
                    <span>Jadwal Meeting</span>
                </a>
            </li>
            <li class="logout">
                <a href="login.html">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </a>
              </li>
        </ul>
    </div>
    <div class="main--content">
        <div class="header--wrapper">
            <div class="header--title">
                <h2>Kelola Jam Operasional Ruang Rapat</h2>
            </div>
        </div>

        <!-- Konten Kelola Ruangan -->
        <div class="tabular--wrapper">
            <button class="add-button">Tambah Data</button>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Jam Meeting</th>
                    <th>Status</th>
                    <th>Lama Durasi</th>
                    <th>Ruang Rapat</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>

          <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Edit Jadwal</h2>
                <form id="editForm">
                    <label for="DurationID" style="display: none;">ID Durasi</label>
                    <input type="hidden" id="DurationID" name="DurationID" readonly>
        
                    <label for="TimePeriod">Jangka Waktu:</label>
                    <input type="text" id="TimePeriod" name="TimePeriod" placeholder="Contoh: 09.00 - 10.00" required>
        
                    <label for="Duration">Lama Waktu:</label>
                    <input type="number" id="Duration" name="Duration" placeholder="1" required min="1">
        
                    <label for="status">Status:</label>
                    <select id="status" name="status" required>
                        <option value="Available">Available</option>
                        <option value="Booked">Booked</option>
                    </select>

                    <label for="room">Ruangan Meeting:</label>
                    <input type="text" id="Room" name="Room" placeholder="Room 1" required min="1">
        
                    <button type="submit">Simpan Perubahan</button>
                </form>
            </div>
        </div>

        <div id="addModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>Tambah Jadwal</h2>
              <form id="addForm">
                <label for="newPeriod">Jangka Waktu:</label>
                <input type="text" id="newPeriod" name="newPeriod" placeholder="09.00 - 10.00" required>
          
                <label for="newDuration">Lama Waktu:</label>
                <input type="number" id="newDuration" name="newDuration" placeholder="1" required>
                
                <label for="newStatus">Status:</label>
                <select id="newStatus" name="newStatus" required>
                    <option value="Available">Available</option>
                    <option value="Booked">Booked</option>
                </select>

                <label for="newRoom">Nama Ruangan:</label>
                <input type="text" id="newRoom" name="newRoom" placeholder="Ruangan 1" required>

                <button type="submit">Tambah Jadwal</button>
              </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const tableBody = document.querySelector("table tbody");
          const editModal = document.getElementById("editModal");
          const addModal = document.getElementById("addModal");
          const closeModal = document.querySelectorAll(".close");
          const editForm = document.getElementById("editForm");
          const DurationIDInput = document.getElementById("DurationID");
          const TimePeriodInput = document.getElementById("TimePeriod");
          const DurationInput = document.getElementById("Duration");
          const Roominput = document.getElementById("Room")
          const addForm = document.getElementById("addForm");
          const newPeriodInput = document.getElementById("newPeriod");
          const newDurationInput = document.getElementById("newDuration");
          const newStatusInput = document.getElementById("newStatus");
          const newRoomInput = document.getElementById("newRoom");
          const addButton = document.querySelector(".add-button");
  
          const fetchSchedule = async () => {
              try {
                  const response = await fetch("http://localhost:5000/JadwalMeeting");
                  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                  const data = await response.json();
                  if (data.status === 200) {
                      populateTable(data.jadwals);
                  } else {
                      console.error("Error fetching rooms:", data.message);
                  }
              } catch (error) {
                  console.error("Error fetching rooms:", error);
              }
          };
  
          const populateTable = (jadwals) => {
                tableBody.innerHTML = "";
                jadwals.forEach((jadwal) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${jadwal.Jangka_Waktu}</td>
                    <td>${jadwal.status}</td>
                    <td>${jadwal.Lama_Waktu} Jam</td>
                    <td>Ruang ${jadwal.ID_Meeting}</td>
                    <td>
                    <button class="delete-button" data-id="${jadwal.ID_Durasi}">Hapus</button>
                    <button 
                      class="edit-button" 
                      data-id="${jadwal.ID_Durasi}"
                      data-name="${jadwal.Jangka_Waktu}" 
                      data-lamawaktu="${jadwal.Lama_Waktu}" 
                      data-status="${jadwal.status}"
                      data-room="${jadwal.ID_Meeting}"
                    > Edit </button>
               </td>
                `;
            tableBody.appendChild(row);
        });
    };
  
          const handleDelete = async (ID_Durasi) => {
              const confirmDelete = confirm("Apakah Anda yakin ingin menghapus ruangan ini?");
              if (!confirmDelete) return;
  
              try {
                  const response = await fetch(`http://localhost:5000/deleteJadwal/${ID_Durasi}`, {
                      method: "DELETE",
                  });
  
                  const result = await response.json();
                  if (response.ok) {
                      alert(result.message);
                      fetchSchedule();
                  } else {
                      alert(`Error: ${result.message}`);
                  }
              } catch (error) {
                  console.error("Error saat menghapus ruangan:", error);
                  alert("Terjadi kesalahan saat menghapus ruangan.");
              }
          };
  
          const handleEdit = (jadwal) => {
            DurationIDInput.value = jadwal.ID_Durasi;
            TimePeriodInput.value = jadwal.Jangka_Waktu;
            DurationInput.value = jadwal.Lama_Waktu;
            document.getElementById("status").value = jadwal.status;
            Roominput.value = jadwal.ID_Meeting;
            editModal.style.display = "block";
        };
  
          const handleAdd = () => {
              addModal.style.display = "block";
          };
  
          closeModal.forEach((modal) => {
              modal.onclick = () => {
                  editModal.style.display = "none";
                  addModal.style.display = "none";
              };
          });
  
          window.onclick = (event) => {
              if (event.target === editModal || event.target === addModal) {
                  editModal.style.display = "none";
                  addModal.style.display = "none";
              }
          };
  
          addForm.onsubmit = async (event) => {
            event.preventDefault();

            const newJadwal = {
                newPeriod: newPeriodInput.value,
                newDuration: parseInt(newDurationInput.value),
                newStatus: newStatusInput.value,
                newRoom: newRoomInput.value
            };

            console.log("Data dikirim ke backend:", newJadwal);
            try {
                const response = await fetch('http://localhost:5000/createjadwal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newJadwal),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Terjadi kesalahan saat menambahkan jadwal');
                }

                const result = await response.json();
                alert(result.message);
                fetchSchedule();
                addForm.reset();
                addModal.style.display = 'none';
            } catch (error) {
                console.error('Error saat menambahkan jadwal:', error);
                alert('Terjadi kesalahan saat menambahkan jadwal.');
            }
        };

        editForm.onsubmit = async (event) => {
            event.preventDefault();

            const updatedJadwal = {
                ID_Durasi: DurationIDInput.value,
                Jangka_Waktu: TimePeriodInput.value,
                Lama_Waktu: parseInt(DurationInput.value),
                status: document.getElementById("status").value,
                ID_Meeting: Roominput.value
            };

            console.log("Data dikirim untuk diperbarui:", updatedJadwal);

            try {
                const response = await fetch('http://localhost:5000/updateJadwal', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedJadwal),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Terjadi kesalahan saat memperbarui jadwal');
                }

                const result = await response.json();
                alert(result.message);
                fetchSchedule();
                editModal.style.display = "none";
            } catch (error) {
                console.error('Error saat memperbarui jadwal:', error);
                alert('Terjadi kesalahan saat memperbarui jadwal.');
            }
        };
  
          document.addEventListener("click", (event) => {
              if (event.target.classList.contains("delete-button")) {
                  const id = event.target.dataset.id;
                  handleDelete(id);
              } else if (event.target.classList.contains("edit-button")) {
                  const jadwal = {
                      ID_Durasi: event.target.dataset.id,
                      Jangka_Waktu: event.target.dataset.name,
                      Lama_Waktu: event.target.dataset.lamawaktu,
                      status: event.target.dataset.status,
                      ID_Meeting: event.target.dataset.room
                  };
                  handleEdit(jadwal);
              } else if (event.target.classList.contains("add-button")) {
                  handleAdd();
              }
          });
          fetchSchedule();
      });
      </script>
      <script src="script.js"></script>
</body>
</html>